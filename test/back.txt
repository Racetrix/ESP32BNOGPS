#pragma once

#include <lvgl.h>
#include <vector>
#include "LGFX_Driver.hpp"
#include "SD_Driver.hpp"
#include "GPS_Driver.hpp"
#include "IMU_Driver.hpp"

extern LGFX tft;
extern IMU_Driver imu;
extern bool sd_connected;

// --- LVGL 缓冲 ---
static lv_disp_draw_buf_t draw_buf;
static lv_color_t buf[240 * 40];
static lv_color_t buf2[240 * 40];

// --- 全局 UI 对象 ---
lv_obj_t *ui_ScreenMain;
lv_obj_t *ui_ScreenConsole;

lv_obj_t *ui_LabelSpeed;
lv_obj_t *ui_ArcSpeed;
lv_obj_t *ui_ObjGball;
lv_obj_t *ui_LabelTimeVal;
lv_obj_t *ui_LabelSatVal;
lv_obj_t *ui_LabelConsole;

// 修改：不再使用 Box 对象，直接控制 Label 颜色
lv_obj_t *ui_LabelSD;
lv_obj_t *ui_LabelBat;
lv_obj_t *ui_LabelIMU;

// --- 样式 ---
lv_style_t style_label_gray;
lv_style_t style_label_cyan;
lv_style_t style_box_outline;

// 前向声明
void build_console(void);

// --- 胶水代码 (保持不变) ---
void my_disp_flush(lv_disp_drv_t *disp, const lv_area_t *area, lv_color_t *color_p)
{
    uint32_t w = (area->x2 - area->x1 + 1);
    uint32_t h = (area->y2 - area->y1 + 1);
    tft.startWrite();
    tft.setAddrWindow(area->x1, area->y1, w, h);
    tft.writePixels((uint16_t *)&color_p->full, w * h, true);
    tft.endWrite();
    lv_disp_flush_ready(disp);
}

void my_touch_read(lv_indev_drv_t *indev_driver, lv_indev_data_t *data)
{
    uint16_t touchX, touchY;
    bool touched = tft.getTouch(&touchX, &touchY);
    if (!touched)
    {
        data->state = LV_INDEV_STATE_REL;
    }
    else
    {
        data->state = LV_INDEV_STATE_PR;
        data->point.x = touchX;
        data->point.y = touchY;
    }
}

void screen_gesture_event_cb(lv_event_t *e)
{
    lv_event_code_t code = lv_event_get_code(e);
    lv_obj_t *current_scr = lv_scr_act();

    if (code == LV_EVENT_GESTURE)
    {
        lv_dir_t dir = lv_indev_get_gesture_dir(lv_indev_get_act());
        if (current_scr == ui_ScreenMain && dir == LV_DIR_LEFT)
        {
            if (!ui_ScreenConsole)
                build_console();
            lv_scr_load_anim(ui_ScreenConsole, LV_SCR_LOAD_ANIM_MOVE_LEFT, 300, 0, false);
        }
        else if (current_scr == ui_ScreenConsole && dir == LV_DIR_RIGHT)
        {
            lv_scr_load_anim(ui_ScreenMain, LV_SCR_LOAD_ANIM_MOVE_RIGHT, 300, 0, false);
        }
    }
}

void btn_back_event_cb(lv_event_t *e)
{
    lv_scr_load_anim(ui_ScreenMain, LV_SCR_LOAD_ANIM_MOVE_RIGHT, 300, 0, false);
}

void init_styles()
{
    lv_style_init(&style_label_gray);
    lv_style_set_text_color(&style_label_gray, lv_color_hex(0x888888));
    lv_style_set_text_font(&style_label_gray, &lv_font_montserrat_14);

    lv_style_init(&style_label_cyan);
    lv_style_set_text_color(&style_label_cyan, lv_color_hex(0x00AEEF));
    lv_style_set_text_font(&style_label_cyan, &lv_font_montserrat_20);

    lv_style_init(&style_box_outline);
    lv_style_set_bg_opa(&style_box_outline, 0);
    lv_style_set_border_width(&style_box_outline, 1);
    lv_style_set_border_color(&style_box_outline, lv_color_hex(0x444444));
    lv_style_set_radius(&style_box_outline, 4); // 稍微大一点圆角
    lv_style_set_text_color(&style_box_outline, lv_color_hex(0x555555));
    lv_style_set_text_font(&style_box_outline, &lv_font_montserrat_14);
}

// 辅助：创建垂直分割线
void create_divider(lv_obj_t *parent, int x_offset)
{
    lv_obj_t *line = lv_obj_create(parent);
    lv_obj_set_size(line, 1, 16); // 高度 16
    lv_obj_set_style_bg_color(line, lv_color_hex(0x444444), LV_PART_MAIN);
    lv_obj_set_style_border_width(line, 0, LV_PART_MAIN);
    lv_obj_align(line, LV_ALIGN_LEFT_MID, x_offset, 0);
    lv_obj_clear_flag(line, LV_OBJ_FLAG_SCROLLABLE);
}

// --- 构建数据终端 (Console) - 保持不变 ---
void build_console()
{
    ui_ScreenConsole = lv_obj_create(NULL);
    lv_obj_set_style_bg_color(ui_ScreenConsole, lv_color_hex(0x000000), LV_PART_MAIN);
    lv_obj_set_scrollbar_mode(ui_ScreenConsole, LV_SCROLLBAR_MODE_AUTO);
    lv_obj_set_scroll_dir(ui_ScreenConsole, LV_DIR_VER);
    lv_obj_add_event_cb(ui_ScreenConsole, screen_gesture_event_cb, LV_EVENT_GESTURE, NULL);

    lv_obj_t *header = lv_obj_create(ui_ScreenConsole);
    lv_obj_set_size(header, 320, 30);
    lv_obj_set_style_bg_color(header, lv_color_hex(0x222222), LV_PART_MAIN);
    lv_obj_set_style_border_width(header, 0, LV_PART_MAIN);
    lv_obj_align(header, LV_ALIGN_TOP_MID, 0, 0);
    lv_obj_clear_flag(header, LV_OBJ_FLAG_SCROLLABLE);

    lv_obj_t *title = lv_label_create(header);
    lv_label_set_text(title, "GPS RAW DATA");
    lv_obj_set_style_text_color(title, lv_color_hex(0x00FF00), LV_PART_MAIN);
    lv_obj_align(title, LV_ALIGN_LEFT_MID, 5, 0);

    lv_obj_t *btn_back = lv_btn_create(header);
    lv_obj_set_size(btn_back, 60, 24);
    lv_obj_align(btn_back, LV_ALIGN_RIGHT_MID, -5, 0);
    lv_obj_set_style_bg_color(btn_back, lv_color_hex(0x444444), LV_PART_MAIN);
    lv_obj_add_event_cb(btn_back, btn_back_event_cb, LV_EVENT_CLICKED, NULL);
    lv_obj_t *lbl_back = lv_label_create(btn_back);
    lv_label_set_text(lbl_back, "BACK");
    lv_obj_center(lbl_back);

    ui_LabelConsole = lv_label_create(ui_ScreenConsole);
    lv_label_set_long_mode(ui_LabelConsole, LV_LABEL_LONG_WRAP);
    lv_obj_set_width(ui_LabelConsole, 310);
    lv_obj_align(ui_LabelConsole, LV_ALIGN_TOP_LEFT, 5, 35);
    lv_obj_set_style_text_color(ui_LabelConsole, lv_color_hex(0xAAAAAA), LV_PART_MAIN);
    lv_obj_set_style_text_font(ui_LabelConsole, &lv_font_montserrat_14, LV_PART_MAIN);
    lv_label_set_text(ui_LabelConsole, "Waiting for data...");
}

// --- 构建主仪表盘 ---
void build_dashboard()
{
    ui_ScreenMain = lv_obj_create(NULL);
    lv_obj_set_style_bg_color(ui_ScreenMain, lv_color_hex(0x000000), LV_PART_MAIN);
    lv_obj_clear_flag(ui_ScreenMain, LV_OBJ_FLAG_SCROLLABLE);
    lv_obj_add_event_cb(ui_ScreenMain, screen_gesture_event_cb, LV_EVENT_GESTURE, NULL);

    // === 1. 左侧速度区域 ===
    lv_obj_t *panel_left = lv_obj_create(ui_ScreenMain);
    lv_obj_set_size(panel_left, 180, 240);
    lv_obj_align(panel_left, LV_ALIGN_LEFT_MID, 0, 0);
    lv_obj_set_style_bg_opa(panel_left, 0, LV_PART_MAIN);
    lv_obj_set_style_border_width(panel_left, 1, LV_PART_MAIN);
    lv_obj_set_style_border_color(panel_left, lv_color_hex(0x333333), LV_PART_MAIN);
    lv_obj_set_style_border_side(panel_left, LV_BORDER_SIDE_RIGHT, LV_PART_MAIN);
    lv_obj_set_style_radius(panel_left, 0, LV_PART_MAIN);
    lv_obj_clear_flag(panel_left, LV_OBJ_FLAG_SCROLLABLE);
    lv_obj_set_scrollbar_mode(panel_left, LV_SCROLLBAR_MODE_OFF);
    lv_obj_set_style_pad_all(panel_left, 0, LV_PART_MAIN); // 清除内边距

    ui_ArcSpeed = lv_arc_create(panel_left);
    lv_obj_set_size(ui_ArcSpeed, 160, 160);
    lv_arc_set_rotation(ui_ArcSpeed, 135);
    lv_arc_set_bg_angles(ui_ArcSpeed, 0, 270);
    lv_arc_set_value(ui_ArcSpeed, 0);
    lv_obj_center(ui_ArcSpeed);
    lv_obj_set_style_arc_width(ui_ArcSpeed, 16, LV_PART_MAIN);
    lv_obj_set_style_arc_width(ui_ArcSpeed, 16, LV_PART_INDICATOR);
    lv_obj_set_style_arc_color(ui_ArcSpeed, lv_color_hex(0x222222), LV_PART_MAIN);
    lv_obj_set_style_arc_color(ui_ArcSpeed, lv_color_hex(0xFFFFFF), LV_PART_INDICATOR);
    lv_obj_remove_style(ui_ArcSpeed, NULL, LV_PART_KNOB);
    lv_obj_clear_flag(ui_ArcSpeed, LV_OBJ_FLAG_CLICKABLE);

    ui_LabelSpeed = lv_label_create(panel_left);
    lv_label_set_text(ui_LabelSpeed, "0");
    lv_obj_set_style_text_font(ui_LabelSpeed, &lv_font_montserrat_48, LV_PART_MAIN);
    lv_obj_set_style_text_color(ui_LabelSpeed, lv_color_hex(0xFFFFFF), LV_PART_MAIN);
    lv_obj_align(ui_LabelSpeed, LV_ALIGN_CENTER, 0, -10);

    lv_obj_t *label_unit = lv_label_create(panel_left);
    lv_label_set_text(label_unit, "KM/H");
    lv_obj_add_style(label_unit, &style_label_cyan, LV_PART_MAIN);
    lv_obj_set_style_text_font(label_unit, &lv_font_montserrat_14, LV_PART_MAIN);
    lv_obj_align(label_unit, LV_ALIGN_CENTER, 0, 35);

    // === 2. 右上 G-Force ===
    lv_obj_t *panel_g = lv_obj_create(ui_ScreenMain);
    lv_obj_set_size(panel_g, 140, 140);
    lv_obj_align(panel_g, LV_ALIGN_TOP_RIGHT, 0, 0);
    lv_obj_set_style_bg_opa(panel_g, 0, LV_PART_MAIN);
    lv_obj_set_style_border_width(panel_g, 1, LV_PART_MAIN);
    lv_obj_set_style_border_color(panel_g, lv_color_hex(0x333333), LV_PART_MAIN);
    lv_obj_set_style_border_side(panel_g, LV_BORDER_SIDE_BOTTOM, LV_PART_MAIN);
    lv_obj_set_style_radius(panel_g, 0, LV_PART_MAIN);
    lv_obj_clear_flag(panel_g, LV_OBJ_FLAG_SCROLLABLE);
    lv_obj_set_scrollbar_mode(panel_g, LV_SCROLLBAR_MODE_OFF);
    lv_obj_set_style_pad_all(panel_g, 0, LV_PART_MAIN); // 清除内边距

    lv_obj_t *g_circle = lv_obj_create(panel_g);
    lv_obj_set_size(g_circle, 90, 90);
    lv_obj_align(g_circle, LV_ALIGN_CENTER, 0, -10);
    lv_obj_set_style_bg_opa(g_circle, 0, LV_PART_MAIN);
    lv_obj_set_style_border_width(g_circle, 1, LV_PART_MAIN);
    lv_obj_set_style_border_color(g_circle, lv_color_hex(0x555555), LV_PART_MAIN);
    lv_obj_set_style_radius(g_circle, LV_RADIUS_CIRCLE, LV_PART_MAIN);
    lv_obj_clear_flag(g_circle, LV_OBJ_FLAG_CLICKABLE | LV_OBJ_FLAG_SCROLLABLE);
    lv_obj_set_scrollbar_mode(g_circle, LV_SCROLLBAR_MODE_OFF);

    lv_obj_t *line_v = lv_obj_create(g_circle);
    lv_obj_set_size(line_v, 1, 90);
    lv_obj_center(line_v);
    lv_obj_set_style_bg_color(line_v, lv_color_hex(0x555555), LV_PART_MAIN);
    lv_obj_set_style_border_width(line_v, 0, LV_PART_MAIN);

    lv_obj_t *line_h = lv_obj_create(g_circle);
    lv_obj_set_size(line_h, 90, 1);
    lv_obj_center(line_h);
    lv_obj_set_style_bg_color(line_h, lv_color_hex(0x555555), LV_PART_MAIN);
    lv_obj_set_style_border_width(line_h, 0, LV_PART_MAIN);

    lv_obj_t *label_g = lv_label_create(panel_g);
    lv_label_set_text(label_g, "G-FORCE");
    lv_obj_add_style(label_g, &style_label_gray, LV_PART_MAIN);
    lv_obj_align(label_g, LV_ALIGN_BOTTOM_RIGHT, -10, -5);

    ui_ObjGball = lv_obj_create(panel_g);
    lv_obj_set_size(ui_ObjGball, 10, 10);
    lv_obj_set_style_radius(ui_ObjGball, LV_RADIUS_CIRCLE, LV_PART_MAIN);
    lv_obj_set_style_bg_color(ui_ObjGball, lv_color_hex(0xFF0000), LV_PART_MAIN);
    lv_obj_set_style_border_width(ui_ObjGball, 0, LV_PART_MAIN);
    lv_obj_align(ui_ObjGball, LV_ALIGN_CENTER, 0, -10);
    lv_obj_clear_flag(ui_ObjGball, LV_OBJ_FLAG_CLICKABLE);

    // === 3. 右下数据区 (panel_data) ===
    lv_obj_t *panel_data = lv_obj_create(ui_ScreenMain);
    lv_obj_set_size(panel_data, 140, 100);
    lv_obj_align(panel_data, LV_ALIGN_BOTTOM_RIGHT, 0, 0);
    lv_obj_set_style_bg_opa(panel_data, 0, LV_PART_MAIN);
    lv_obj_set_style_border_width(panel_data, 0, LV_PART_MAIN);
    lv_obj_clear_flag(panel_data, LV_OBJ_FLAG_SCROLLABLE);
    lv_obj_set_scrollbar_mode(panel_data, LV_SCROLLBAR_MODE_OFF);
    lv_obj_set_style_pad_all(panel_data, 0, LV_PART_MAIN);

    // --- Time 行 (Y=5) ---
    lv_obj_t *lbl_time = lv_label_create(panel_data);
    lv_label_set_text(lbl_time, "TIME");
    lv_obj_add_style(lbl_time, &style_label_gray, LV_PART_MAIN);
    lv_obj_align(lbl_time, LV_ALIGN_TOP_LEFT, 10, 5);

    ui_LabelTimeVal = lv_label_create(panel_data);
    lv_label_set_text(ui_LabelTimeVal, "00:00");
    lv_obj_add_style(ui_LabelTimeVal, &style_label_cyan, LV_PART_MAIN);
    lv_obj_align(ui_LabelTimeVal, LV_ALIGN_TOP_RIGHT, -10, 3);

    // --- GPS 行 (Y=33) ---
    lv_obj_t *lbl_gps = lv_label_create(panel_data);
    lv_label_set_text(lbl_gps, "GPS");
    lv_obj_add_style(lbl_gps, &style_label_gray, LV_PART_MAIN);
    lv_obj_align(lbl_gps, LV_ALIGN_TOP_LEFT, 10, 33);

    ui_LabelSatVal = lv_label_create(panel_data);
    lv_label_set_text(ui_LabelSatVal, "0 SAT");
    lv_obj_set_style_text_color(ui_LabelSatVal, lv_color_hex(0xFFFFFF), LV_PART_MAIN);
    lv_obj_set_style_text_font(ui_LabelSatVal, &lv_font_montserrat_14, LV_PART_MAIN);
    lv_obj_align(ui_LabelSatVal, LV_ALIGN_TOP_RIGHT, -10, 33);

    // === 状态栏 (Width=122) ===
    lv_obj_t *status_bar = lv_obj_create(panel_data);
    lv_obj_set_size(status_bar, 122, 26);
    lv_obj_align(status_bar, LV_ALIGN_BOTTOM_MID, 0, -10);
    lv_obj_add_style(status_bar, &style_box_outline, LV_PART_MAIN);
    lv_obj_clear_flag(status_bar, LV_OBJ_FLAG_SCROLLABLE | LV_OBJ_FLAG_CLICKABLE);
    lv_obj_set_scrollbar_mode(status_bar, LV_SCROLLBAR_MODE_OFF);

    // SD (X=14)
    ui_LabelSD = lv_label_create(status_bar);
    lv_label_set_text(ui_LabelSD, "SD");
    lv_obj_set_style_text_font(ui_LabelSD, &lv_font_montserrat_14, LV_PART_MAIN);
    lv_obj_set_style_text_color(ui_LabelSD, lv_color_hex(0x555555), LV_PART_MAIN);
    lv_obj_align(ui_LabelSD, LV_ALIGN_LEFT_MID, -5, 0);

    // 分割线 1 (位置 45)
    create_divider(status_bar, 22);

    // 2. BAT (正中间)
    ui_LabelBat = lv_label_create(status_bar);
    lv_label_set_text(ui_LabelBat, "BAT");
    lv_obj_set_style_text_font(ui_LabelBat, &lv_font_montserrat_14, LV_PART_MAIN);
    lv_obj_set_style_text_color(ui_LabelBat, lv_color_hex(0x555555), LV_PART_MAIN);
    lv_obj_align(ui_LabelBat, LV_ALIGN_CENTER, -3, 0);

    // 分割线 2 (位置 91)
    create_divider(status_bar, 65);

    // 3. IMU (右侧区域)
    // 避免短线跑到字上面，往右挪一点
    ui_LabelIMU = lv_label_create(status_bar);
    lv_label_set_text(ui_LabelIMU, "IMU");
    lv_obj_set_style_text_font(ui_LabelIMU, &lv_font_montserrat_14, LV_PART_MAIN);
    lv_obj_set_style_text_color(ui_LabelIMU, lv_color_hex(0x555555), LV_PART_MAIN);
    // 稍微靠右对齐，Offset -12px
    lv_obj_align(ui_LabelIMU, LV_ALIGN_RIGHT_MID, 5, 0);
}

// 初始化 UI
void init_ui()
{
    lv_init();
    lv_disp_draw_buf_init(&draw_buf, buf, buf2, 240 * 40);
    static lv_disp_drv_t disp_drv;
    lv_disp_drv_init(&disp_drv);
    disp_drv.hor_res = 320;
    disp_drv.ver_res = 240;
    disp_drv.flush_cb = my_disp_flush;
    disp_drv.draw_buf = &draw_buf;
    lv_disp_drv_register(&disp_drv);

    static lv_indev_drv_t indev_drv;
    lv_indev_drv_init(&indev_drv);
    indev_drv.type = LV_INDEV_TYPE_POINTER;
    indev_drv.read_cb = my_touch_read;
    lv_indev_drv_register(&indev_drv);

    init_styles();
    build_dashboard();
    build_console();
    lv_scr_load(ui_ScreenMain);
}

// === 状态更新函数 (修改为直接操作 Label) ===
void update_dev_status(bool bat_detected)
{
    // 1. SD 卡状态
    if (ui_LabelSD)
    {
        lv_color_t color = sd_connected ? lv_color_hex(0x00FF00) : lv_color_hex(0x555555);
        lv_obj_set_style_text_color(ui_LabelSD, color, LV_PART_MAIN);
    }

    // 2. 电池状态
    if (ui_LabelBat)
    {
        lv_color_t color = bat_detected ? lv_color_hex(0x00FF00) : lv_color_hex(0x555555);
        lv_obj_set_style_text_color(ui_LabelBat, color, LV_PART_MAIN);
    }
}

void update_ui_loop()
{
    lv_timer_handler();

    if (lv_scr_act() == ui_ScreenConsole && ui_LabelConsole)
    {
        static uint32_t last_log_update = 0;
        if (millis() - last_log_update > 200)
        {
            last_log_update = millis();
            lv_label_set_text(ui_LabelConsole, gps_log_buffer.c_str());
        }
    }

    static uint32_t last_ball_update = 0;
    if (millis() - last_ball_update > 30)
    {
        last_ball_update = millis();

        if (ui_ObjGball)
        {
            float gx = imu.ax;
            float gy = imu.ay;
            if (gx > 1.5)
                gx = 1.5;
            if (gx < -1.5)
                gx = -1.5;
            if (gy > 1.5)
                gy = 1.5;
            if (gy < -1.5)
                gy = -1.5;
            int offset_x = (int)(gx * 30);
            int offset_y = (int)(gy * 30);
            lv_obj_align(ui_ObjGball, LV_ALIGN_CENTER, offset_x, offset_y - 10);
        }

        if (ui_LabelIMU)
        {
            lv_color_t color = imu.isConnected ? lv_color_hex(0x00FF00) : lv_color_hex(0x555555);
            lv_obj_set_style_text_color(ui_LabelIMU, color, LV_PART_MAIN);
        }
    }
}